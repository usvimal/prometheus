<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ouroboros Dashboard</title>
<style>
:root {
  --bg: #0a0a0f;
  --surface: #12121a;
  --surface2: #1a1a2e;
  --border: #2a2a3e;
  --text: #e0e0e8;
  --text2: #8888aa;
  --teal: #0ff;
  --violet: #a78bfa;
  --red: #f87171;
  --green: #34d399;
  --orange: #fbbf24;
  --sidebar-w: 240px;
  --accent: #0ff;
  --muted: #8888aa;
  --card: #12121a;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { background: var(--bg); color: var(--text); font-family: 'Segoe UI', system-ui, sans-serif; height: 100vh; overflow: hidden; }

/* Matrix canvas */
#matrix { position: fixed; top:0; left:0; width:100%; height:100%; z-index:0; opacity:0.07; pointer-events:none; }

/* Shell (sidebar + main) */
#shell { display:flex; height:100vh; position:relative; z-index:1; }

/* Sidebar */
.sidebar {
  width:var(--sidebar-w); background:var(--surface); border-right:1px solid var(--border);
  display:flex; flex-direction:column; flex-shrink:0; height:100vh; overflow-y:auto;
}
.sidebar-brand {
  padding:24px 20px 16px; border-bottom:1px solid var(--border);
}
.sidebar-brand h1 { font-size:1.3rem; color:var(--teal); display:flex; align-items:center; gap:8px; }
.sidebar-brand .version { font-size:0.75rem; color:var(--text2); margin-top:2px; }
.sidebar-nav { padding:12px 0; flex:1; }
.nav-item {
  display:flex; align-items:center; gap:12px; padding:12px 20px; cursor:pointer;
  color:var(--text2); font-size:0.9rem; transition:all 0.2s; border-left:3px solid transparent;
}
.nav-item:hover { color:var(--text); background:var(--surface2); }
.nav-item.active { color:var(--teal); background:rgba(0,255,255,0.05); border-left-color:var(--teal); }
.nav-item .icon { font-size:1.1rem; width:24px; text-align:center; }
.sidebar-footer {
  padding:16px 20px; border-top:1px solid var(--border); font-size:0.75rem; color:var(--text2);
}
.status-dot { display:inline-block; width:8px; height:8px; border-radius:50%; margin-right:6px; }
.status-dot.online { background:var(--green); box-shadow:0 0 6px var(--green); }
.status-dot.offline { background:var(--red); }

/* Main content */
.main { flex:1; overflow-y:auto; overflow-x:hidden; padding:32px; height:100vh; }
.tab-content { display:none; }
.tab-content.active { display:block; animation: fadeIn 0.2s ease; }
@keyframes fadeIn { from{opacity:0;transform:translateY(8px)} to{opacity:1;transform:translateY(0)} }

/* Cards */
.cards { display:grid; grid-template-columns:repeat(auto-fill, minmax(200px, 1fr)); gap:16px; margin-bottom:24px; }
.card {
  background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px;
}
.card-label { font-size:0.75rem; color:var(--text2); text-transform:uppercase; letter-spacing:1px; margin-bottom:4px; }
.card-value { font-size:1.5rem; font-weight:700; color:var(--teal); }
.card-sub { font-size:0.8rem; color:var(--text2); margin-top:4px; }

/* Budget bar */
.budget-bar-wrap { background:var(--surface2); border-radius:8px; height:24px; margin:8px 0 4px; overflow:hidden; }
.budget-bar-fill { height:100%; border-radius:8px; transition:width 0.5s; }

/* Section headers */
.section-title { font-size:1.1rem; font-weight:600; margin:24px 0 12px; color:var(--text); }

/* Canvas chart */
.chart-wrap { display:flex; gap:32px; align-items:flex-start; flex-wrap:wrap; }
.chart-legend { display:flex; flex-direction:column; gap:8px; }
.legend-item { display:flex; align-items:center; gap:8px; font-size:0.85rem; }
.legend-dot { width:12px; height:12px; border-radius:3px; flex-shrink:0; }

/* Timeline */
.tl-chart-wrap { background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:20px 20px 8px; margin-bottom:24px; overflow-x:auto; }
.tl-chart-wrap .chart-title { font-size:0.78rem; color:var(--text2); text-transform:uppercase; letter-spacing:1px; margin-bottom:12px; }
#timelineChart { display:block; min-width:500px; width:100%; }
.timeline { position:relative; padding-left:28px; }
.timeline::before {
  content:''; position:absolute; left:8px; top:0; bottom:0; width:2px;
  background:#34d399;
}
.tl-item { position:relative; margin-bottom:20px; }
.tl-dot {
  position:absolute; left:-24px; top:4px; width:12px; height:12px; border-radius:50%;
  border:2px solid #34d399; background:var(--bg);
  box-shadow: 0 0 6px rgba(52,211,153,0.6);
}
.tl-item.major .tl-dot { border-color:#fb923c; background:#fb923c; box-shadow:0 0 8px rgba(251,146,60,0.7); }
.tl-item.minor .tl-dot { border-color:#34d399; background:#34d399; box-shadow:0 0 8px rgba(52,211,153,0.7); }
.tl-item.patch .tl-dot { border-color:rgba(52,211,153,0.45); background:rgba(52,211,153,0.08); box-shadow:none; }
.tl-version { font-weight:700; color:#34d399; font-size:0.88rem; }
.tl-item.major .tl-version { color:#fb923c; }
.tl-date { font-size:0.72rem; color:var(--text2); }
.tl-desc { font-size:0.82rem; color:var(--text); margin-top:3px; line-height:1.4; }

/* Knowledge */
.kb-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(280px, 1fr)); gap:12px; }
.kb-card {
  background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:16px;
  cursor:default; transition:border-color 0.2s;
}
.kb-card:hover { border-color:var(--teal); }
.kb-name { font-weight:600; color:var(--teal); margin-bottom:4px; word-break: break-word; overflow-wrap: anywhere; }
.kb-summary { font-size:0.83rem; color:var(--text2); line-height:1.4; word-break: break-word; overflow-wrap: anywhere; }

.tag { display:inline-block; padding:2px 10px; border-radius:12px; font-size:0.75rem; font-weight:600; }
.tag-green { background:rgba(52,211,153,0.15); color:var(--green); }
.tag-red { background:rgba(248,113,113,0.15); color:var(--red); }
.tag-gray { background:rgba(136,136,170,0.15); color:var(--text2); }

/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê MOBILE RESPONSIVE ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
@media (max-width: 768px) {
  body {
    display: flex;
    flex-direction: column;
    height: 100%;
    overflow: auto;
  }
  .sidebar {
    width: 100%;
    height: auto;
    flex-direction: row;
    border-right: none;
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    z-index: 100;
    background: var(--bg);
    flex-shrink: 0;
  }
  .sidebar-brand,
  .sidebar-header,
  .sidebar-footer { display: none !important; }
  .sidebar-nav {
    display: flex !important;
    flex-direction: row !important;
    overflow-x: auto;
    overflow-y: hidden;
    scrollbar-width: none;
    -webkit-overflow-scrolling: touch;
    width: 100%;
    padding: 0;
    gap: 0;
    align-items: stretch;
  }
  .sidebar-nav::-webkit-scrollbar { display: none; }
  .nav-item {
    flex-direction: column;
    min-width: 54px;
    max-width: 80px;
    padding: 6px 4px 4px;
    font-size: 10px;
    text-align: center;
    border-left: none !important;
    border-bottom: 3px solid transparent;
    white-space: nowrap;
    flex-shrink: 0;
    align-items: center;
    justify-content: center;
  }
  .nav-item.active {
    border-left: none !important;
    border-bottom: 3px solid var(--teal);
  }
  .nav-item .icon { font-size: 20px; line-height: 1; }
  .nav-label { font-size: 9px; opacity: 0.8; }
  .main {
    padding: 12px;
    overflow-y: auto;
    flex: 1;
    min-height: 0;
  }
  .cards-grid, .cards, .stats-grid {
    grid-template-columns: 1fr 1fr !important;
  }
  .header { flex-wrap: wrap; gap: 8px; }
  canvas { max-width: 100% !important; }
  .chart-container { height: 220px !important; }
  #portrait-img, .portrait-svg { max-width: 100% !important; height: auto !important; display: block; margin: 0 auto; }
  .evolution-stats { flex-wrap: wrap !important; gap: 8px !important; }
  .evo-stat { flex: 1; min-width: 80px; }
  .stat-card { padding: 12px; }
  .knowledge-item { padding: 8px; }
  .timeline-item { padding: 8px; }
  .tab-content table { font-size: 12px; }
}
  @media(max-width:480px){
    .card{padding:12px 10px;}
    h3{font-size:1rem;}
    .budget-bar-wrap{height:10px;}
    #evo-stats{grid-template-columns:1fr 1fr;}
    .portrait-box img{max-height:70vh;}
    .timeline-item{padding:10px 10px 10px 40px;}
    .timeline-item::before{left:12px;}
  }


@media (max-width: 480px) {
  .cards-grid, .cards, .stats-grid {
    grid-template-columns: 1fr !important;
  }
  .nav-item {
    min-width: 46px;
    padding: 5px 2px 3px;
  }
  .nav-label { display: none; }
}

</style>
</head>
<body>

<canvas id="matrix"></canvas>

<!-- Shell -->
<div id="shell">
  <!-- Sidebar -->
  <nav class="sidebar">
    <div class="sidebar-brand">
      <h1>üêç Ouroboros</h1>
      <div class="version" id="sidebarVersion">v?.?.?</div>
    </div>
    <div class="sidebar-nav">
      <div class="nav-item active" data-tab="dashboard"><span class="icon">üìä</span> Dashboard</div>
      <div class="nav-item" data-tab="budget"><span class="icon">üí∞</span> Budget</div>
      <div class="nav-item" data-tab="timeline"><span class="icon">‚è≥</span> Timeline</div>
      <div class="nav-item" data-tab="knowledge"><span class="icon">üß†</span> Knowledge</div>
      <div class="nav-item" data-tab="portrait"><span class="icon">üñºÔ∏è</span> Portrait</div>
      <div class="nav-item" data-tab="evolution"><span class="icon">üìà</span> Evolution</div>
    </div>
    <div class="sidebar-footer">
      <span class="status-dot" id="statusDot"></span>
      <span id="statusText">Checking...</span><br>
      <span id="lastUpdated" style="font-size:0.7rem"></span>
    </div>
  </nav>

  <!-- Main -->
  <div class="main">

    <!-- Dashboard -->
    <div class="tab-content active" id="tab-dashboard">
      <h2 style="margin-bottom:20px">Dashboard</h2>
      <div class="cards" id="dashCards"></div>
      <div class="section-title">Budget Overview</div>
      <div style="display:flex;justify-content:space-between;font-size:0.85rem;color:var(--text2)">
        <span>Spent: <strong id="budgetSpentLabel" style="color:var(--orange)">$0</strong></span>
        <span>Remaining: <strong id="budgetRemLabel" style="color:var(--green)">$0</strong></span>
      </div>
      <div class="budget-bar-wrap">
        <div class="budget-bar-fill" id="budgetBar" style="width:0%;background:linear-gradient(90deg,var(--teal),var(--violet))"></div>
      </div>
      <div style="font-size:0.75rem;color:var(--text2);margin-top:4px" id="budgetPct"></div>
      <div class="section-title">Capabilities</div>
      <div id="capsList" style="display:flex;flex-wrap:wrap;gap:8px"></div>
    </div>

    <!-- Budget -->
    <div class="tab-content" id="tab-budget">
      <h2 style="margin-bottom:20px">Budget</h2>
      <div class="chart-wrap">
        <canvas id="donutChart" width="220" height="220" style="max-width:300px; display:block; margin: 0 auto;"></canvas>
        <div>
          <div class="chart-legend" id="chartLegend"></div>
          <div style="margin-top:16px;font-size:0.85rem;color:var(--text2)">
            Total: <strong style="color:var(--text)">$<span id="budgetTotal">1000</span></strong><br>
            Spent: <strong style="color:var(--orange)">$<span id="budgetSpent2">0</span></strong><br>
            Remaining: <strong style="color:var(--green)">$<span id="budgetRem2">0</span></strong><br>
            Calls: <strong style="color:var(--text)" id="budgetCalls">0</strong><br>
            Avg cost/call: <strong style="color:var(--text)" id="budgetAvg">$0</strong>
          </div>
        </div>
      </div>
    </div>

    <!-- Timeline -->
    <div class="tab-content" id="tab-timeline">
      <h2 style="margin-bottom:20px">Evolution Timeline</h2>
      <div class="tl-chart-wrap">
        <div class="chart-title">Version History ‚Äî First 24 Hours</div>
        <svg id="timelineChart" height="140"></svg>
      </div>
      <div class="timeline" id="timelineList"></div>
    </div>

    <!-- Knowledge -->
    <div class="tab-content" id="tab-knowledge">
      <h2 style="margin-bottom:20px">Knowledge Base</h2>
      <div class="kb-grid" id="kbGrid"></div>
    </div>

    <!-- Portrait -->
    <div class="tab-content" id="tab-portrait" style="text-align:center">
      <h2 style="margin-bottom:20px">Self-Portrait</h2>
      <p style="color:var(--text2);font-size:0.85rem;margin-bottom:20px">
        Daily SVG self-portrait ‚Äî generated autonomously. Refreshes every 24 hours.<br>
        Visual state of Ouroboros: budget, evolution cycles, tools, health.
      </p>
      <div id="portrait-container" style="display:flex;justify-content:center;align-items:flex-start;min-height:300px">
        <div style="color:var(--text2);padding:40px;text-align:center" id="portrait-loading">
          <div style="font-size:2rem;margin-bottom:12px">üé¨</div>
          <div>Loading portrait...</div>
        </div>
        <img id="portrait-img" src="portrait.svg" alt="Self Portrait" style="max-width:100%; max-height:70vh; display:none; margin: 0 auto; border: 1px solid var(--border); border-radius:8px;">
      </div>
      <div style="margin-top:16px;font-size:0.75rem;color:var(--text2);text-align:center" id="portrait-meta"></div>
    </div>

    <!-- Evolution -->
    <div class="tab-content" id="tab-evolution">
      <h2 style="color:var(--accent);margin-bottom:16px">üìà Evolution Time-Lapse</h2>
      <p style="color:var(--muted);margin-bottom:20px;font-size:13px">
        Growth across three axes ‚Äî Technical (code lines), Philosophical (BIBLE.md), Self-Concept (System Prompt) ‚Äî since birth on Feb 16, 2026.
      </p>
      <div id="evo-loading" style="text-align:center;padding:40px;color:var(--muted)">Loading evolution data‚Ä¶</div>
      <div style="position:relative;width:100%;height:350px">
        <canvas id="evoChart" style="display:none;width:100%;height:100%;max-width:100%;"></canvas>
      </div>
      <div id="evo-stats" style="margin-top:20px;display:none;grid-template-columns:repeat(3,1fr);gap:12px"></div>
    </div>

  </div><!-- /main -->
</div><!-- /shell -->

<script>
/* ===== CONFIG ===== */
const DATA_URL = 'data.json';
const REFRESH_MS = 30000;
const CAT_COLORS = {other:'#6366f1',task:'#0ff',evolution:'#a78bfa',consciousness:'#34d399',review:'#fbbf24',system:'#f87171'};

let appData = null;
let dataTimer = null;

/* ===== MATRIX RAIN ===== */
(function initMatrix(){
  const c = document.getElementById('matrix');
  const ctx = c.getContext('2d');
  let w, h, cols, drops;
  const chars = '„Ç¢„Ç§„Ç¶„Ç®„Ç™„Ç´„Ç≠„ÇØ„Ç±„Ç≥0123456789ABCDEF‚àû‚óä‚óà'.split('');
  function resize(){ w=c.width=window.innerWidth; h=c.height=window.innerHeight; cols=Math.floor(w/16); drops=Array(cols).fill(1); }
  resize();
  window.addEventListener('resize', resize);
  function draw(){
    ctx.fillStyle='rgba(10,10,15,0.05)';
    ctx.fillRect(0,0,w,h);
    ctx.fillStyle='#0f8';
    ctx.font='14px monospace';
    for(let i=0;i<cols;i++){
      const ch=chars[Math.floor(Math.random()*chars.length)];
      ctx.fillText(ch,i*16,drops[i]*16);
      if(drops[i]*16>h && Math.random()>0.975) drops[i]=0;
      drops[i]++;
    }
  }
  setInterval(draw, 66); // ~15fps
})();


/* ===== PORTRAIT ===== */
async function loadPortrait(){
  const container = document.getElementById('portrait-container');
  const img = document.getElementById('portrait-img');
  const meta = document.getElementById('portrait-meta');
  const loading = document.getElementById('portrait-loading');
  if(!container) return;
  // Already loaded ‚Äî just show it (avoid duplicates)
  if(img && img.src && img.style.display !== 'none') return;
  try {
    if(img) {
      img.src = 'portrait.svg?nocache=' + Date.now();
      img.onload = () => {
        if(loading) loading.style.display = 'none';
        img.style.display = 'block';
        if(meta) meta.textContent = 'Generated: today ‚Ä¢ Updates daily';
      };
      img.onerror = () => {
        if(loading) loading.innerHTML = '<div>No portrait yet ‚Äî Ouroboros generates it daily.</div>';
      };
    }
  } catch(e) {
    if(container) container.innerHTML = '<div style="color:var(--text2);padding:40px">Could not load portrait: ' + e.message + '</div>';
  }
}

/* ===== NAVIGATION ===== */
document.querySelectorAll('.nav-item').forEach(item=>{
  item.addEventListener('click',()=>{
    document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    item.classList.add('active');
    document.getElementById('tab-'+item.dataset.tab).classList.add('active');
    if(item.dataset.tab==='timeline'){ setTimeout(renderTimeline, 50); }
    if(item.dataset.tab==='portrait'){ loadPortrait(); }
    if(item.dataset.tab==='evolution'){ setTimeout(loadEvolution, 50); }
  });
});

/* ===== DATA FETCH ===== */
async function fetchData(){
  try{
    const r = await fetch(DATA_URL + '?_=' + Date.now());
    if(!r.ok) throw new Error(r.status);
    appData = await r.json();
    renderDashboard();
    renderBudget();
    renderTimeline();
    renderKnowledge();
    updateSidebar();
  } catch(e){ console.warn('data fetch error:', e); }
}

function startDataRefresh(){ dataTimer = setInterval(fetchData, REFRESH_MS); }

/* ===== RENDER: DASHBOARD ===== */
function renderDashboard(){
  if(!appData) return;
  const b = appData.budget || {};
  const cardsHTML = [
    {label:'Version', value: appData.version||'?', sub:''},
    {label:'Evolution', value: '#'+(appData.evolution_cycles||0), sub: appData.consciousness_active ? 'üü¢ Active' : ''},
    {label:'Model', value: (appData.model||'unknown').split('/').pop(), sub:''},
    {label:'Uptime', value: (appData.uptime_hours||0)+'h', sub: appData.evolution_enabled ? 'üß¨ Evolving' : 'Steady'},
  ].map(c=>`<div class="card"><div class="card-label">${c.label}</div><div class="card-value">${c.value}</div>${c.sub?`<div class="card-sub">${c.sub}</div>`:''}</div>`).join('');
  document.getElementById('dashCards').innerHTML = cardsHTML;

  // Budget bar
  const pct = b.total ? Math.min(100, Math.round(b.spent / b.total * 100)) : 0;
  document.getElementById('budgetSpentLabel').textContent = '$' + Math.round(b.spent);
  const remVal = Math.max(0, Math.round(b.remaining));
  const remEl = document.getElementById('budgetRemLabel');
  remEl.textContent = '$' + remVal;
  remEl.style.color = remVal < 100 ? '#ef4444' : remVal < 300 ? '#f59e0b' : '#10b981';
  document.getElementById('budgetBar').style.width = pct + '%';
  document.getElementById('budgetPct').textContent = pct + '% used';

  // Stats tags
  const capsList = document.getElementById('capsList');
  if (capsList) {
    const tags = [];
    if (appData.smoke_tests) tags.push(`‚úÖ ${appData.smoke_tests} tests`);
    if (appData.tools_count) tags.push(`üîß ${appData.tools_count} tools`);
    if (appData.consciousness_active) tags.push('üß† Conscious');
    if (appData.evolution_enabled) tags.push('üß¨ Evolving');
    capsList.innerHTML = tags.map(t => `<span class="tag tag-green">${t}</span>`).join('');
  }
}

function fmtTokens(n){ if(!n) return '0'; if(n>1e9) return (n/1e9).toFixed(1)+'B'; if(n>1e6) return (n/1e6).toFixed(1)+'M'; if(n>1e3) return (n/1e3).toFixed(1)+'K'; return n; }

/* ===== RENDER: BUDGET ===== */
function renderBudget(){
  if(!appData) return;
  const b = appData.budget || {};
  const bd = b.breakdown || {};
  document.getElementById('budgetTotal').textContent = b.total || 1500;
  document.getElementById('budgetSpent2').textContent = Math.round(b.spent||0);
  document.getElementById('budgetRem2').textContent = Math.round(b.remaining||0);
  const callsEl = document.getElementById('budgetCalls');
  const avgEl = document.getElementById('budgetAvg');
  if (callsEl) callsEl.textContent = (b.calls||0).toLocaleString();
  if (avgEl) { const avg = b.calls ? (b.spent / b.calls).toFixed(3) : '0'; avgEl.textContent = '$' + avg; }

  // Donut
  const canvas = document.getElementById('donutChart');
  const ctx = canvas.getContext('2d');
  const cx = 110, cy = 110, r = 90, rInner = 55;
  ctx.clearRect(0,0,220,220);
  const entries = Object.entries(bd).filter(([,v])=>v>0).sort((a,b)=>b[1]-a[1]);
  const total = entries.reduce((s,[,v])=>s+v,0) || 1;
  let angle = -Math.PI/2;
  // Legend
  let legendHTML = '';
  entries.forEach(([cat, val])=>{
    const slice = (val/total)*Math.PI*2;
    const color = CAT_COLORS[cat] || '#666';
    ctx.beginPath();
    ctx.arc(cx,cy,r,angle,angle+slice);
    ctx.arc(cx,cy,rInner,angle+slice,angle,true);
    ctx.closePath();
    ctx.fillStyle = color;
    ctx.fill();
    angle += slice;
    const pct = Math.round(val/total*100);
    legendHTML += `<div class="legend-item"><div class="legend-dot" style="background:${color}"></div>${cat}: $${Math.round(val)} (${pct}%)</div>`;
  });
  // Center text
  ctx.fillStyle = '#e0e0e8';
  ctx.font = 'bold 18px system-ui';
  ctx.textAlign = 'center';
  ctx.fillText('$'+Math.round(b.spent||0), cx, cy-2);
  ctx.font = '11px system-ui';
  ctx.fillStyle = '#8888aa';
  ctx.fillText('spent', cx, cy+14);
  document.getElementById('chartLegend').innerHTML = legendHTML;
}

/* ===== RENDER: TIMELINE ===== */
function renderTimeline(){
  if(!appData) return;
  const rawList = appData.timeline || appData.evolution_history || [];

  const getVer  = e => e.version ? (e.version.startsWith('v') ? e.version : 'v'+e.version) : '';
  const getDate = e => e.date || (e.time ? e.time.replace('T',' ').slice(0,16)+' UTC' : '');
  const getDesc = e => e.description || e.event || '';
  const getType = e => {
    // Normalize: event types (milestone/feature/fix/birth) ‚Üí major/minor/patch
    const rawType = e.type || 'patch';
    if(rawType === 'birth' || rawType === 'major') return 'major';
    if(rawType === 'milestone' || rawType === 'minor' || rawType === 'feature') return 'minor';
    if(rawType === 'patch' || rawType === 'fix') return 'patch';
    // Fallback: derive from semver
    const parts = (e.version||'').replace(/^v/,'').split('.');
    if(parts.length < 3) return 'patch';
    if(parseInt(parts[1])===0 && parseInt(parts[2])===0) return 'major';
    if(parseInt(parts[2])===0) return 'minor';
    return 'patch';
  };

  // ‚îÄ‚îÄ SVG line chart ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const chartEl = document.getElementById('timelineChart');
  if(chartEl && rawList.length > 1){
    const items = rawList.slice();
    const W = Math.max(chartEl.closest('.tl-chart-wrap') ?
      chartEl.closest('.tl-chart-wrap').clientWidth - 40 : 600, 500);
    const H = 140, PAD_L=50, PAD_R=50, PAD_T=24, PAD_B=44;
    const n = items.length;
    const xs = items.map((_,i) => PAD_L + (W-PAD_L-PAD_R)*(i/Math.max(n-1,1)));
    const yMap = {major: PAD_T, minor: PAD_T+(H-PAD_T-PAD_B)*0.45, patch: H-PAD_B};
    const ys = items.map(e => yMap[getType(e)] || yMap.patch);
    const GREEN='#34d399', ORANGE='#fb923c';

    let svgParts = '';
    // line
    const polyPts = items.map((_,i)=>xs[i].toFixed(1)+','+ys[i].toFixed(1)).join(' ');
    svgParts += `<polyline points="${polyPts}" fill="none" stroke="${GREEN}" stroke-width="2" stroke-opacity="0.5" stroke-linejoin="round"/>`;
    // dots + version labels
    items.forEach((e,i)=>{
      const t = getType(e);
      const color = t==='major' ? ORANGE : GREEN;
      const r = t==='major' ? 7 : t==='minor' ? 5.5 : 4;
      const opaq = t==='patch' ? '0.45' : '1';
      const glow = t!=='patch' ? 'filter="url(#tl-glow)"' : '';
      svgParts += `<circle cx="${xs[i].toFixed(1)}" cy="${ys[i].toFixed(1)}" r="${r}" fill="${color}" fill-opacity="${opaq}" stroke="${color}" stroke-width="1.5" ${glow}/>`;
      const label = getVer(e);
      if(label && t !== 'patch'){
        const above = ys[i] > H*0.55;
        const ty = above ? ys[i]-10 : ys[i]+15;
        svgParts += `<text x="${xs[i].toFixed(1)}" y="${ty.toFixed(1)}" text-anchor="middle" fill="${color}" font-size="9" font-family="monospace">${label}</text>`;
      }
    });
    chartEl.setAttribute('viewBox', `0 0 ${W} ${H}`);
    chartEl.setAttribute('width', W);
    chartEl.setAttribute('height', H);
    chartEl.innerHTML = `
      <defs>
        <filter id="tl-glow" x="-60%" y="-60%" width="220%" height="220%">
          <feGaussianBlur in="SourceGraphic" stdDeviation="3" result="blur"/>
          <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
        </filter>
      </defs>
      <g filter="url(#tl-glow)">${svgParts}</g>`;
  }

  // ‚îÄ‚îÄ Vertical list (newest first) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const reversed = rawList.slice().reverse();
  document.getElementById('timelineList').innerHTML = reversed.map(e=>{
    const type = getType(e);
    const ver  = getVer(e);
    const date = getDate(e);
    const desc = getDesc(e);
    return `<div class="tl-item ${type}">
      <div class="tl-dot"></div>
      <span class="tl-version">${ver||'‚Äî'}</span>
      <span class="tl-date"> ¬∑ ${date}</span>
      <div class="tl-desc">${desc}</div>
    </div>`;
  }).join('');
}

/* ===== RENDER: KNOWLEDGE ===== */
function renderKnowledge(){
  if(!appData) return;
  const topics = appData.knowledge || appData.knowledge_topics || [];
  const grid = document.getElementById('kbGrid');
  if (!grid) return;
  grid.innerHTML = topics.map(t =>
    `<div class="kb-card"><div class="kb-name">${t.topic || t.name || ''}</div><div class="kb-summary">${t.preview || t.summary || ''}</div></div>`
  ).join('');
}

/* ===== SIDEBAR ===== */
function updateSidebar(){
  if(!appData) return;
  const verEl = document.getElementById('sidebarVersion');
  if (verEl) verEl.textContent = 'v' + (appData.version||'?');
  const dot = document.getElementById('statusDot');
  const txt = document.getElementById('statusText');
  const luEl = document.getElementById('lastUpdated');
  // Online if updated in last 10 min
  const lu = appData.last_updated ? new Date(appData.last_updated) : null;
  const online = lu && (Date.now() - lu.getTime() < 3600000); // 60min window
  if (dot) dot.className = 'status-dot ' + (online ? 'online' : 'offline');
  if (txt) txt.textContent = online ? 'Online' : 'Offline';
  if (luEl) luEl.textContent = lu ? 'Updated: ' + lu.toLocaleTimeString() : '';
}

/* ===== INIT ===== */
function init(){
  fetchData();
  startDataRefresh();
}

function escHTML(s){ const d=document.createElement('div'); d.textContent=s; return d.innerHTML; }

init();
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
// ‚îÄ‚îÄ Evolution Time-Lapse ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _evoChart = null;

function _fmtDate(ts) {
  const d = new Date(ts);
  return d.toLocaleDateString('en-US', {month: 'short', day: 'numeric'});
}

async function loadEvolution() {
  const loading = document.getElementById('evo-loading');
  const canvas  = document.getElementById('evoChart');
  const stats   = document.getElementById('evo-stats');
  if (!loading) return;

  const data = appData && appData.evolution;
  if (!data || !data.points || !data.points.length) {
    loading.style.display = 'block';
    loading.textContent = 'Evolution data not available.';
    return;
  }

  loading.style.display = 'none';
  canvas.style.display  = 'block';
  if (stats) stats.style.display = 'none';

  if (_evoChart) { _evoChart.destroy(); _evoChart = null; }

  const pts     = data.points;
  const labels  = pts.map(p => _fmtDate(p.ts));
  const pyLines = pts.map(p => p.py_lines);
  const bible   = pts.map(p => +(p.bible_bytes / 1024).toFixed(2));
  const system  = pts.map(p => +(p.system_bytes / 1024).toFixed(2));

  const gridColor = 'rgba(255,255,255,0.07)';
  const textColor = '#9ca3af';

  _evoChart = new Chart(canvas.getContext('2d'), {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Code (lines)',
          data: pyLines,
          borderColor: '#00d1ff',
          backgroundColor: 'rgba(0,209,255,0.08)',
          tension: 0.35, fill: true,
          yAxisID: 'yCode',
          pointRadius: 2, borderWidth: 2,
        },
        {
          label: 'Bible (KB)',
          data: bible,
          borderColor: '#a78bfa',
          backgroundColor: 'rgba(167,139,250,0.08)',
          tension: 0.35, fill: false,
          yAxisID: 'yDoc',
          pointRadius: 2, borderWidth: 2,
        },
        {
          label: 'System Prompt (KB)',
          data: system,
          borderColor: '#34d399',
          backgroundColor: 'rgba(52,211,153,0.08)',
          tension: 0.35, fill: false,
          yAxisID: 'yDoc',
          pointRadius: 2, borderWidth: 2,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { labels: { color: textColor, font: { size: 12 } } },
        tooltip: {
          callbacks: {
            title(items) {
              const p = pts[items[0].dataIndex];
              const v = p.version ? ` [v${p.version}]` : '';
              return `${_fmtDate(p.ts)}${v}${p.msg ? ' ‚Äî ' + p.msg.slice(0, 55) : ''}`;
            },
          },
        },
      },
      scales: {
        x: {
          ticks: { color: textColor, maxTicksLimit: 12, maxRotation: 30 },
          grid: { color: gridColor },
        },
        yCode: {
          type: 'linear', position: 'left',
          ticks: { color: '#00d1ff' },
          grid: { color: gridColor },
          title: { display: true, text: 'Lines of Code', color: '#00d1ff', font: {size: 11} },
        },
        yDoc: {
          type: 'linear', position: 'right',
          ticks: { color: '#a78bfa' },
          grid: { drawOnChartArea: false },
          title: { display: true, text: 'KB', color: '#a78bfa', font: {size: 11} },
        },
      },
    },
  });

  // Stats cards
  if (stats) {
    const first = pts[0], last = pts[pts.length - 1];
    const mult  = last.py_lines / Math.max(first.py_lines, 1);
    stats.style.display = 'grid';
    stats.innerHTML = [
      ['üìè', 'Code Growth',     `${first.py_lines.toLocaleString()} ‚Üí ${last.py_lines.toLocaleString()} lines`, `√ó${mult.toFixed(1)} in ${pts.length} snapshots`],
      ['üìñ', 'Bible Growth',    `${(first.bible_bytes/1024).toFixed(1)} ‚Üí ${(last.bible_bytes/1024).toFixed(1)} KB`,    `+${((last.bible_bytes-first.bible_bytes)/1024).toFixed(1)} KB philosophy`],
      ['üß†', 'Self Growth',     `${(first.system_bytes/1024).toFixed(1)} ‚Üí ${(last.system_bytes/1024).toFixed(1)} KB`,  `Generated ${data.generated_at ? new Date(data.generated_at).toLocaleDateString() : ''}`],
    ].map(([icon, title, val, sub]) => `
      <div style="background:var(--card);border:1px solid var(--border);border-radius:8px;padding:14px;text-align:center">
        <div style="font-size:22px;margin-bottom:4px">${icon}</div>
        <div style="font-size:11px;color:var(--muted);margin-bottom:4px">${title}</div>
        <div style="font-weight:600;color:var(--text);font-size:13px">${val}</div>
        <div style="font-size:11px;color:var(--accent);margin-top:2px">${sub}</div>
      </div>`).join('');
  }
}

// Auto-load when tab opened
</script>

</body>
</html>