<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prometheus Dashboard</title>
<style>
  :root {
    --bg: #0d1117; --surface: #161b22; --border: #30363d;
    --text: #c9d1d9; --text-dim: #8b949e; --accent: #f0883e;
    --green: #3fb950; --red: #f85149; --blue: #58a6ff; --purple: #bc8cff;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', monospace; background: var(--bg); color: var(--text); }

  /* Header */
  .header { padding: 14px 24px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 12px; }
  .header h1 { font-size: 18px; color: var(--accent); font-weight: 600; }
  .header .dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); flex-shrink: 0; }
  .header .dot.off { background: var(--red); }
  .header .meta { margin-left: auto; color: var(--text-dim); font-size: 12px; display: flex; gap: 16px; }

  /* Tabs */
  .tabs { display: flex; border-bottom: 1px solid var(--border); padding: 0 24px; gap: 0; }
  .tab { padding: 10px 18px; cursor: pointer; color: var(--text-dim); font-size: 13px; font-weight: 500;
         border-bottom: 2px solid transparent; transition: all 0.15s; }
  .tab:hover { color: var(--text); }
  .tab.active { color: var(--accent); border-bottom-color: var(--accent); }
  .tab-content { display: none; padding: 20px 24px; }
  .tab-content.active { display: block; }

  /* Grid */
  .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 14px; }
  @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
  .grid-3 { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 14px; }
  @media (max-width: 900px) { .grid-3 { grid-template-columns: 1fr; } }

  /* Cards */
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: 8px; padding: 14px; }
  .card h2 { font-size: 11px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.8px; margin-bottom: 10px; }
  .card.full { grid-column: 1 / -1; }
  .metric { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid var(--border); font-size: 13px; }
  .metric:last-child { border-bottom: none; }
  .metric .label { color: var(--text-dim); }
  .metric .value { font-weight: 600; font-family: monospace; }
  .green { color: var(--green); } .red { color: var(--red); }
  .accent { color: var(--accent); } .blue { color: var(--blue); } .purple { color: var(--purple); }

  /* Budget bar */
  .bar { height: 5px; background: var(--border); border-radius: 3px; margin-top: 8px; overflow: hidden; }
  .bar .fill { height: 100%; border-radius: 3px; transition: width 0.5s; }

  /* Badge */
  .badge { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600; }
  .badge.ok { background: rgba(63,185,80,0.15); color: var(--green); }
  .badge.warn { background: rgba(240,136,62,0.15); color: var(--accent); }
  .badge.err { background: rgba(248,81,73,0.15); color: var(--red); }

  /* Logs */
  .log-list { max-height: 400px; overflow-y: auto; font-size: 12px; font-family: monospace; }
  .log-entry { padding: 3px 0; border-bottom: 1px solid var(--border); word-break: break-all; line-height: 1.5; }
  .log-entry .ts { color: var(--text-dim); margin-right: 6px; }
  .log-entry .type { color: var(--blue); margin-right: 6px; }
  .log-entry .msg { color: var(--text); }

  /* Sub-tabs for logs */
  .sub-tabs { display: flex; gap: 0; margin-bottom: 12px; }
  .sub-tab { padding: 6px 14px; cursor: pointer; color: var(--text-dim); font-size: 12px;
             background: var(--surface); border: 1px solid var(--border); }
  .sub-tab:first-child { border-radius: 6px 0 0 6px; }
  .sub-tab:last-child { border-radius: 0 6px 6px 0; }
  .sub-tab.active { background: var(--border); color: var(--text); }

  /* Memory markdown */
  .md-content { font-size: 13px; line-height: 1.6; white-space: pre-wrap; max-height: 350px; overflow-y: auto;
                padding: 10px; background: var(--bg); border-radius: 6px; border: 1px solid var(--border); }

  /* Queue items */
  .queue-item { padding: 6px 0; border-bottom: 1px solid var(--border); display: flex; gap: 8px; align-items: center; font-size: 13px; }
  .queue-item .id { color: var(--accent); font-family: monospace; font-size: 12px; }
  .queue-item .type { background: var(--border); padding: 2px 6px; border-radius: 4px; font-size: 11px; }

  /* Evolution table */
  .evo-table { width: 100%; border-collapse: collapse; font-size: 12px; }
  .evo-table th { text-align: left; color: var(--text-dim); padding: 6px 8px; border-bottom: 1px solid var(--border); font-weight: 500; }
  .evo-table td { padding: 5px 8px; border-bottom: 1px solid var(--border); font-family: monospace; }
</style>
</head>
<body>

<div class="header">
  <div class="dot" id="statusDot"></div>
  <h1>Prometheus</h1>
  <div class="meta">
    <span id="uptimeInfo">-</span>
    <span id="refreshInfo">Loading...</span>
  </div>
</div>

<div class="tabs">
  <div class="tab active" data-tab="overview">Overview</div>
  <div class="tab" data-tab="logs">Logs</div>
  <div class="tab" data-tab="memory">Memory</div>
  <div class="tab" data-tab="evolution">Evolution</div>
</div>

<!-- ===== OVERVIEW TAB ===== -->
<div class="tab-content active" id="tab-overview">
  <div class="grid">
    <div class="card">
      <h2>Budget</h2>
      <div class="metric"><span class="label">Spent</span><span class="value accent" id="budgetSpent">-</span></div>
      <div class="metric"><span class="label">Remaining</span><span class="value green" id="budgetRemaining">-</span></div>
      <div class="metric"><span class="label">Total</span><span class="value" id="budgetTotal">-</span></div>
      <div class="bar"><div class="fill" id="budgetFill" style="width:0%;background:var(--green)"></div></div>
    </div>
    <div class="card">
      <h2>Session</h2>
      <div class="metric"><span class="label">Branch</span><span class="value blue" id="branch">-</span></div>
      <div class="metric"><span class="label">SHA</span><span class="value" id="sha">-</span></div>
      <div class="metric"><span class="label">LLM Calls</span><span class="value" id="calls">-</span></div>
      <div class="metric"><span class="label">Tokens (in / out)</span><span class="value" id="tokens">-</span></div>
      <div class="metric"><span class="label">Last Message</span><span class="value" id="lastMsg">-</span></div>
    </div>
    <div class="card">
      <h2>Kimi 5h Window</h2>
      <div class="metric"><span class="label">Calls</span><span class="value" id="kimiCalls">-</span></div>
      <div class="metric"><span class="label">Input Tokens</span><span class="value" id="kimiIn">-</span></div>
      <div class="metric"><span class="label">Output Tokens</span><span class="value" id="kimiOut">-</span></div>
      <div class="metric"><span class="label">Window Remaining</span><span class="value green" id="kimiWindow">-</span></div>
    </div>
    <div class="card">
      <h2>System</h2>
      <div class="metric"><span class="label">Evolution</span><span class="value" id="evolution">-</span></div>
      <div class="metric"><span class="label">Dashboard</span><span class="value" id="dashboardStatus">-</span></div>
      <div class="metric"><span class="label">Codex Auth</span><span class="value" id="codexStatus">-</span></div>
    </div>
    <div class="card full">
      <h2>Task Queue</h2>
      <div id="queueList" class="log-list" style="max-height:200px"><em style="color:var(--text-dim)">No tasks</em></div>
    </div>
  </div>
</div>

<!-- ===== LOGS TAB ===== -->
<div class="tab-content" id="tab-logs">
  <div class="sub-tabs">
    <div class="sub-tab active" data-log="events">Events</div>
    <div class="sub-tab" data-log="supervisor">Supervisor</div>
    <div class="sub-tab" data-log="chat">Chat</div>
    <div class="sub-tab" data-log="progress">Progress</div>
  </div>
  <div class="card">
    <div id="logViewer" class="log-list" style="max-height:500px"><em style="color:var(--text-dim)">Loading...</em></div>
  </div>
</div>

<!-- ===== MEMORY TAB ===== -->
<div class="tab-content" id="tab-memory">
  <div class="grid-3">
    <div class="card"><h2>Identity</h2><div class="md-content" id="memIdentity">Loading...</div></div>
    <div class="card"><h2>Goals</h2><div class="md-content" id="memGoals">Loading...</div></div>
    <div class="card"><h2>Scratchpad</h2><div class="md-content" id="memScratchpad">Loading...</div></div>
  </div>
</div>

<!-- ===== EVOLUTION TAB ===== -->
<div class="tab-content" id="tab-evolution">
  <div class="grid">
    <div class="card">
      <h2>Stats</h2>
      <div class="metric"><span class="label">Total Cycles</span><span class="value" id="evoTotal">-</span></div>
      <div class="metric"><span class="label">Successes</span><span class="value green" id="evoSuccess">-</span></div>
      <div class="metric"><span class="label">Failures</span><span class="value red" id="evoFail">-</span></div>
      <div class="metric"><span class="label">Success Rate</span><span class="value accent" id="evoRate">-</span></div>
    </div>
    <div class="card">
      <h2>Current State</h2>
      <div class="metric"><span class="label">Mode</span><span class="value" id="evoMode">-</span></div>
      <div class="metric"><span class="label">Cycle</span><span class="value" id="evoCycle">-</span></div>
      <div class="metric"><span class="label">Consecutive Failures</span><span class="value" id="evoConsecFail">-</span></div>
    </div>
    <div class="card full">
      <h2>Recent Cycles</h2>
      <table class="evo-table">
        <thead><tr><th>Task ID</th><th>Status</th><th>Duration</th><th>Rounds</th><th>Time</th></tr></thead>
        <tbody id="evoCycles"><tr><td colspan="5" style="color:var(--text-dim)">Loading...</td></tr></tbody>
      </table>
    </div>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
const esc = s => { const d = document.createElement('div'); d.textContent = String(s); return d.innerHTML; };
const fmtN = n => n >= 1e6 ? (n/1e6).toFixed(1)+'M' : n >= 1e3 ? Math.round(n/1e3)+'k' : String(n);

function fmtTime(iso) {
  if (!iso) return '-';
  try {
    const diff = (Date.now() - new Date(iso)) / 1000;
    if (diff < 60) return Math.floor(diff) + 's ago';
    if (diff < 3600) return Math.floor(diff/60) + 'm ago';
    if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
    return Math.floor(diff/86400) + 'd ago';
  } catch { return iso; }
}

function fmtUptime(sec) {
  if (sec < 60) return sec + 's';
  if (sec < 3600) return Math.floor(sec/60) + 'm ' + (sec%60) + 's';
  if (sec < 86400) { const h = Math.floor(sec/3600); return h + 'h ' + Math.floor((sec%3600)/60) + 'm'; }
  return Math.floor(sec/86400) + 'd ' + Math.floor((sec%86400)/3600) + 'h';
}

function fmtSec(sec) {
  if (!sec && sec !== 0) return '-';
  if (sec < 60) return sec + 's';
  return Math.floor(sec/60) + 'm ' + (sec%60) + 's';
}

async function fetchJSON(url) {
  try { const r = await fetch(url); if (!r.ok) throw 0; return await r.json(); } catch { return null; }
}

// Tab switching
document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => {
  document.querySelectorAll('.tab').forEach(x => x.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  $('tab-' + t.dataset.tab).classList.add('active');
  if (t.dataset.tab === 'logs') loadLogs();
  if (t.dataset.tab === 'memory') loadMemory();
  if (t.dataset.tab === 'evolution') loadEvolution();
}));

// Log sub-tabs
let activeLog = 'events';
document.querySelectorAll('.sub-tab').forEach(t => t.addEventListener('click', () => {
  document.querySelectorAll('.sub-tab').forEach(x => x.classList.remove('active'));
  t.classList.add('active');
  activeLog = t.dataset.log;
  loadLogs();
}));

// Overview
async function refreshOverview() {
  const [status, queue, codex] = await Promise.all([
    fetchJSON('/api/status'), fetchJSON('/api/queue'), fetchJSON('/api/codex/status'),
  ]);
  if (!status) { $('statusDot').className = 'dot off'; return; }
  $('statusDot').className = 'dot';
  $('uptimeInfo').textContent = 'Up ' + fmtUptime(status.uptime_sec || 0);

  // Budget
  const b = status.budget;
  if (b.mode === 'subscription' && b.calls_remaining != null) {
    $('budgetSpent').textContent = b.calls_used + ' / ' + b.calls_total + ' calls';
    $('budgetRemaining').textContent = b.calls_remaining + ' left';
    $('budgetTotal').textContent = 'Resets in ' + (b.window_resets_in_min||'?') + 'm';
    const pct = Math.min(100, (b.calls_used/b.calls_total)*100);
    $('budgetFill').style.width = pct+'%';
    $('budgetFill').style.background = pct>90?'var(--red)':pct>70?'var(--accent)':'var(--blue)';
  } else if (b.mode === 'subscription') {
    $('budgetSpent').textContent = '$'+b.spent.toFixed(2);
    $('budgetRemaining').textContent = 'Subscription';
    $('budgetTotal').textContent = '-';
  } else {
    $('budgetSpent').textContent = '$'+b.spent.toFixed(2);
    $('budgetRemaining').textContent = '$'+b.remaining.toFixed(2);
    $('budgetTotal').textContent = '$'+b.total.toFixed(0);
    const pct = Math.min(100, b.pct);
    $('budgetFill').style.width = pct+'%';
    $('budgetFill').style.background = pct>80?'var(--red)':pct>50?'var(--accent)':'var(--green)';
  }

  // Session
  $('branch').textContent = status.branch || '-';
  $('sha').textContent = (status.sha||'-').substring(0,8);
  $('calls').textContent = (status.calls||0).toLocaleString();
  const t = status.tokens;
  $('tokens').textContent = fmtN(t.prompt||0) + ' / ' + fmtN(t.completion||0);
  $('lastMsg').textContent = fmtTime(status.last_owner_message);

  // Kimi
  const k = status.kimi || {};
  $('kimiCalls').textContent = (k.calls||0).toLocaleString();
  $('kimiIn').textContent = fmtN(k.input_tokens||0);
  $('kimiOut').textContent = fmtN(k.output_tokens||0);
  const krem = k.window_remaining_sec || 0;
  $('kimiWindow').textContent = Math.floor(krem/3600)+'h '+Math.floor((krem%3600)/60)+'m';

  // System
  const ev = status.evolution;
  $('evolution').innerHTML = ev.enabled ? '<span class="badge ok">ON</span> cycle '+ev.cycle : '<span class="badge">OFF</span>';
  $('dashboardStatus').innerHTML = '<span class="badge ok">ON</span>';
  if (codex) {
    $('codexStatus').innerHTML = codex.authenticated ? '<span class="badge ok">Auth</span>' : '<span class="badge err">None</span>';
  }

  // Queue
  if (queue && queue.length > 0) {
    $('queueList').innerHTML = queue.map(q =>
      '<div class="queue-item"><span class="id">'+esc((q.id||'?').substring(0,8))+
      '</span><span class="type">'+esc(q.type||'?')+
      '</span><span>'+esc((q.text||'').substring(0,60))+'</span></div>'
    ).join('');
  } else {
    $('queueList').innerHTML = '<em style="color:var(--text-dim)">Queue empty</em>';
  }
  $('refreshInfo').textContent = new Date().toLocaleTimeString();
}

// Logs
const logUrls = {
  events: '/api/logs/events?limit=100', supervisor: '/api/logs/supervisor?limit=100',
  chat: '/api/logs/chat?limit=100', progress: '/api/logs/progress?limit=100',
};
async function loadLogs() {
  const data = await fetchJSON(logUrls[activeLog]);
  if (!data || !data.length) { $('logViewer').innerHTML = '<em style="color:var(--text-dim)">No entries</em>'; return; }
  $('logViewer').innerHTML = data.slice().reverse().map(e => {
    const ts = esc((e.ts||'').substring(11,19));
    if (activeLog === 'chat') {
      const dir = e.direction==='out' ? '<span class="accent">&rarr;</span>' : '<span class="blue">&larr;</span>';
      return '<div class="log-entry"><span class="ts">'+ts+'</span>'+dir+' <span class="msg">'+esc((e.text||'').substring(0,200))+'</span></div>';
    }
    if (activeLog === 'progress') {
      return '<div class="log-entry"><span class="ts">'+ts+'</span><span class="msg">'+esc((e.text||'').substring(0,300))+'</span></div>';
    }
    return '<div class="log-entry"><span class="ts">'+ts+'</span><span class="type">'+esc(e.type||e.event||'?')+'</span>'+
           (e.task_id?'<span class="accent"> '+esc(e.task_id)+'</span>':'')+'</div>';
  }).join('');
}

// Memory
async function loadMemory() {
  const [i,g,s] = await Promise.all([
    fetchJSON('/api/memory/identity'), fetchJSON('/api/memory/goals'), fetchJSON('/api/memory/scratchpad'),
  ]);
  $('memIdentity').textContent = (i&&i.content)||'(empty)';
  $('memGoals').textContent = (g&&g.content)||'(empty)';
  $('memScratchpad').textContent = (s&&s.content)||'(empty)';
}

// Evolution
async function loadEvolution() {
  const [status, stats] = await Promise.all([fetchJSON('/api/status'), fetchJSON('/api/evolution/stats')]);
  if (status) {
    const ev = status.evolution;
    $('evoMode').innerHTML = ev.enabled ? '<span class="badge ok">ON</span>' : '<span class="badge">OFF</span>';
    $('evoCycle').textContent = ev.cycle || 0;
    $('evoConsecFail').textContent = ev.consecutive_failures || 0;
  }
  if (stats) {
    $('evoTotal').textContent = stats.total_cycles || 0;
    $('evoSuccess').textContent = stats.successes || 0;
    $('evoFail').textContent = stats.failures || 0;
    $('evoRate').textContent = (stats.success_rate_pct||0) + '%';
    const cycles = stats.recent_cycles || [];
    if (cycles.length) {
      $('evoCycles').innerHTML = cycles.map(c =>
        '<tr><td>'+esc((c.task_id||'?').substring(0,8))+'</td>'+
        '<td>'+(c.status==='success'?'<span class="green">success</span>':
                c.status==='failed'?'<span class="red">failed</span>':
                '<span class="accent">'+esc(c.status)+'</span>')+'</td>'+
        '<td>'+fmtSec(c.duration_sec)+'</td><td>'+(c.rounds||'-')+'</td><td>'+fmtTime(c.ts)+'</td></tr>'
      ).join('');
    } else {
      $('evoCycles').innerHTML = '<tr><td colspan="5" style="color:var(--text-dim)">No cycles</td></tr>';
    }
  }
}

refreshOverview();
setInterval(refreshOverview, 5000);
</script>
</body>
</html>
